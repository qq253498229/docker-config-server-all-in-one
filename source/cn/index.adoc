= Spring Cloud 配置中心
:toc: left
:docinfo: shared
:docinfodir: ../css
:stylesheet: ../css/adoc-github.css
:nofooter:

== 快速开始

本项目最快的启动方式就是使用 https://www.docker.com/[`docker`]，并且 `docker` 官方提供的 https://docs.docker.com/compose/[`docker-compose`] 更会简化部署流程。

NOTE: 如果您熟悉Spring Cloud 以及 NodeJS ，也可以直接拉取本项目的前后端源代码来启动

=== 启动配置中心

使用本项目提供的 https://raw.githubusercontent.com/qq253498229/docker-config-server-all-in-one/master/docker-compose.yml[`docker-compose`](其中 https://raw.githubusercontent.com/qq253498229/docker-config-server-all-in-one/master/schema.sql[`schema.sql`]必须和 `docker-compose.yml` 放在同一目录) 可以一键创建配置中心后端以及依赖的数据库，并初始化数据库结构。

启动服务后即可访问 http://localhost 来管理配置中心了

=== 创建配置并关联应用

为了适配多项目，所以进入页面后首先需要创建一个项目。

image::picture/1.png[]

创建项目后可以根据需求创建对应的环境，以及每个环境中的配置。应用则代表具体的服务，在应用详情中将应用和配置进行关联，之后就可以进行客户端连接了。

image::picture/2.png[]

=== 客户端连接配置中心读取配置

首先客户端需要在 `pom.xml` 中添加依赖:

----
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-config</artifactId>
</dependency>
----

NOTE: 该依赖的版本号应该从 SpringCloudDependencies 中继承

然后创建 `bootstrap.yml` 文件:

NOTE: `bootstrap.yml` 文件只在示例中使用，实际开发/部署时可以根据需求自行配置，只需在 `spring.profiles.active` 中包含对应的环境编号即可。

----
spring:
  cloud:
    config:
      uri: http://localhost <!--1-->
  application:
    name: TestProject_UserService <!--2-->
  profiles:
    active: ProductionEnv <!--3-->
----
<1> 默认情况下，配置中心不使用任何注册中心，所以客户端应该使用 `地址+端口号` 的方式直连配置中心。
<2> 使用 `项目编号_应用编号` 的方式区分项目和应用
<3> `环境编号`

之后启动客户端可以发现，已经从配置中心中读取了对应的配置:

[source%nowrap]
----
  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::        (v2.3.1.RELEASE)

2020-06-18 15:40:45.422  INFO 61911 --- [           main] c.c.c.ConfigServicePropertySourceLocator : Fetching config from server at : http://localhost
2020-06-18 15:40:45.553  WARN 61911 --- [           main] c.c.c.ConfigServicePropertySourceLocator : Could not locate PropertySource: Could not extract response: no suitable HttpMessageConverter found for response type [class org.springframework.cloud.config.environment.Environment] and content type [text/html]
2020-06-18 15:40:45.556  INFO 61911 --- [           main] com.example.demo.DemoApplication         : The following profiles are active: ProductionEnv
2020-06-18 15:40:46.205  INFO 61911 --- [           main] o.s.cloud.context.scope.GenericScope     : BeanFactory id=9451707b-647f-3f81-8517-6d49f66f4a74
2020-06-18 15:40:46.405  INFO 61911 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 30006 (http)
2020-06-18 15:40:46.413  INFO 61911 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2020-06-18 15:40:46.413  INFO 61911 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.36]
2020-06-18 15:40:46.494  INFO 61911 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2020-06-18 15:40:46.495  INFO 61911 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 928 ms
2020-06-18 15:40:46.787  INFO 61911 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'
2020-06-18 15:40:47.180  INFO 61911 --- [           main] o.s.b.a.e.web.EndpointLinksResolver      : Exposing 2 endpoint(s) beneath base path '/actuator'
2020-06-18 15:40:47.264  INFO 61911 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 30006 (http) with context path ''
2020-06-18 15:40:47.279  INFO 61911 --- [           main] com.example.demo.DemoApplication         : Started DemoApplication in 2.716 seconds (JVM running for 3.584)
2020-06-18 15:40:47.539  INFO 61911 --- [on(1)-127.0.0.1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'
2020-06-18 15:40:47.539  INFO 61911 --- [on(1)-127.0.0.1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
2020-06-18 15:40:47.542  INFO 61911 --- [on(2)-127.0.0.1] c.c.c.ConfigServicePropertySourceLocator : Fetching config from server at : http://localhost
2020-06-18 15:40:47.548  INFO 61911 --- [on(1)-127.0.0.1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 9 ms
2020-06-18 15:40:47.549  WARN 61911 --- [on(2)-127.0.0.1] c.c.c.ConfigServicePropertySourceLocator : Could not locate PropertySource: Could not extract response: no suitable HttpMessageConverter found for response type [class org.springframework.cloud.config.environment.Environment] and content type [text/html]
----

== 配置中心后端

快速开始中使用的镜像，本质上就是提取前后端镜像中的业务代码，打包成一个新的镜像。 所以后端的配置同样可以套用到快速开始中。

后端采用 `SpringBoot 2.3.1.RELEASE`、 `SpringCloud Hoxton.SR5` 版本开发，数据库使用的是 `MySQL`，注册中心支持 `Eureka` 和 `Consul`。如果没有满足您的需求，可以在 <<contribution>> 中查看并提交issues或自行修改。

=== 后端支持参数

.后端支持参数
[%autowidth]
|===
| 参数名 | 默认值 | 说明

|SERVER_PORT
|8888
|后端暴露的端口

|MYSQL_HOST
|localhost
|数据库地址

|MYSQL_PORT
|3306
|数据库端口号

|MYSQL_DATABASE
|application_configuration
|数据库名

|MYSQL_USERNAME
|root
|数据库登录名

|MYSQL_PASSWORD
|root
|数据库登录密码

|APPLICATION_NAME
|config-server
|SpringBoot中的 `spring.application.name`

|DISCOVERY_TYPE
|url
|注册中心类型，`url/eureka/consul`，其中 url 表示不使用注册中心

|CONSUL_TOKEN
|B595BC8E-DE44-4510-82D7-ECF5657F4D4D
|当 DISCOVERY_TYPE 为 `consul` 时生效，表示 consul的 `acl_token`

|CONSUL_HOST
|8500
|当 DISCOVERY_TYPE 为 `consul` 时生效，表示 consul的地址

|CONSUL_PORT
|8500
|当 DISCOVERY_TYPE 为 `consul` 时生效，表示 consul的端口号

|EUREKA_SERVICE_URL
|http://admin:admin@localhost:8761/eureka/
|当 DISCOVERY_TYPE 为 `eureka` 时生效，表示 eureka 的注册地址

|MONITOR_TYPE
| none
| 通知推送类型，`none/rabbitmq`，其中 none 表示不使用通知推送功能

|RABBITMQ_HOST
| localhost
| 当 MONITOR_TYPE 为 `rabbitmq` 时生效，表示 rabbitmq 的地址

|RABBITMQ_PORT
| 5672
| 当 MONITOR_TYPE 为 `rabbitmq` 时生效，表示 rabbitmq 的端口号

|RABBITMQ_USERNAME
| admin
| 当 MONITOR_TYPE 为 `rabbitmq` 时生效，表示 rabbitmq 的用户名

|RABBITMQ_PASSWORD
| admin
| 当 MONITOR_TYPE 为 `rabbitmq` 时生效，表示 rabbitmq 的密码

|RABBITMQ_EXCHANGE_NAME
| config-server-exchange
| 当 MONITOR_TYPE 为 rabbitmq 时生效，表示 rabbitmq 的交换机名称

|RABBITMQ_QUEUE_NAME
| config-server-queue
| 当 MONITOR_TYPE 为 rabbitmq 时生效，表示 rabbitmq 的队列名称。最终队列名为：`${RABBITMQ_EXCHANGE_NAME}.${RABBITMQ_QUEUE_NAME}`
|===

== 配置中心前端

前端使用了 https://angular.cn/[Angular 9] 、 https://ng.ant.design/[NG-ZORRO]， 以及 https://github.com/brtnshrdr/angular2-hotkeys#readme[angular2-hotkeys] 、 https://lodash.com/[lodash] 等。

=== 前端支持参数

.前端支持参数
[%autowidth]
|===
| 参数名 | 默认值 | 说明

|BACKEND_PATH
|http://config:8888
|Nginx中反向代理的后端地址
|===

NOTE: 注意这个参数在快速启动中不生效，因为前后端使用的是同一个容器，所以固定为 http://localhost:8888

== 推送通知功能

后端配置 `MONITOR_TYPE` 参数为 `"rabbitmq"` ，并配置rabbitmq的必要参数 `RABBITMQ_HOST` 、`RABBITMQ_PORT`、`RABBITMQ_USERNAME`、`RABBITMQ_PASSWORD` 之后，即可开启推送通知功能，此时后端会自动向rabbitmq注册一条

== 源码地址

源码托管在 https://gitee.com/[Gitee] 中：

https://gitee.com/consolelog/codeforfun-config-server-frontend[Gitee-配置中心-前端]、
https://gitee.com/consolelog/codeforfun-config-server[Gitee-配置中心-后端]、
https://gitee.com/consolelog/docker-config-server-all-in-one[Gitee配置中心-快速启动]

同时也提供了 https://github.com/[Github] 地址作为备用：

https://github.com/qq253498229/codeforfun-config-frontend[Github-配置中心-前端]、
https://github.com/qq253498229/codeforfun-config-server[Github-配置中心-后端]、
https://github.com/qq253498229/docker-config-server-all-in-one[Gitee配置中心-快速启动]

== 开源协议

本项目遵循 MIT 协议，虽然我也不知道这个协议具体是啥意思，但是原则上你可以随便使用本项目，当然前提是不触犯法律: http://xingfa.org/[中华人民共和国刑法] 、 https://paperclip.feishu.cn/file/boxcnZGTyENVDRcBIRUlFtM0YVf[中华人民共和国民法典(草案)]。

== 更新日志

暂无

[[contribution]]
== 贡献指南

你可以在 https://gitee.com/consolelog/codeforfun-config-server-frontend/issues[前端] 、 https://gitee.com/consolelog/codeforfun-config-server/issues[后端] 以及 https://gitee.com/consolelog/docker-config-server-all-in-one/issues[快速启动] 的 issues 列表中提交 issue。

同时您也可以提供 PullRequest 贡献代码。